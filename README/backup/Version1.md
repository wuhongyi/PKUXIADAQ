<!-- Version1.md --- 
;; 
;; Description: 
;; Author: Hongyi Wu(吴鸿毅)
;; Email: wuhongyi@qq.com 
;; Created: 四 7月 21 14:18:36 2016 (+0800)
;; Last-Updated: 四 7月 21 18:51:29 2016 (+0800)
;;           By: Hongyi Wu(吴鸿毅)
;;     Update #: 17
;; URL: http://wuhongyi.cn -->

# XIA 获取当前进度

----

## XIA 与 CAEN 的区别

CAEN 插件在采集波形时，一个插件所有通道每个事件的采样长度只能设置成相同的。而 XIA 插件可以每个通道单独设置，例如：ch-0 设置采3000个点，ch-1 设置采2000个点，ch-2 设置采5000个点，ch-3 设置成不采集波形……。

在读取数据时候，CAEN 插件每次拿到的数据都是完整事件的数据。而 XIA 插件 FIFO 的读指针、写指针是独立的、同时进行的，所以每次我们要取数据时候都需要先查询下当前 FIFO 有多少数据，然后再指定该次读取多少数据。因为FIFO读、写是独立的，因而查询到的数据量是该时刻拥有的数据量，这个数据量基本都不是完整事件的数据量（还有部分是当前事件正在写入的）。每个事件除了有 4 words 的 header 及后面紧跟着的数据外并没有事件标记符，当然这样设计最大的好处就是速度快。

## 灵活性带来的问题

基于以上事实，两个公司的产品对用户写时时监视获取率、在线监视程序等的实现方式存在较大差异。

CAEN：
由于 CAEN 一个插件上每个通道的采样数相同，因而他们每个事件的长度是一致的。在拿到数据时即可存文件或者 decode 出每个事件的信息用来统计时时获取速率，也可将数据发送到在线程序。

XIA：
由于其上每个通道数据长度可单独设置，这是 XIA 插件的灵活性。又 FIFO 查询到的数据量是当前时刻的数据量，这样每次取到的数据都不是完整事件的数据。

对于多个插件的系统，获取时候一直循环读取每一个插件上的数据，如果将所有插件的数据存在同一个文件内，将造成数据的错乱。如果每个插件的数据单独存在一个文件内，那么下一次读取的该插件的数据中开头的不完整事件的数据刚好接上一次最后一个不完整事件的数据，可解决这个问题。

由于每次拿到的不是完整数据，因此也不好 decode 当前数据来获得每个事件的信息（从开始就decode记录每次数据的不完整事件的情况也可解决该问题，但是这样decode需要额外的时间）。但是 XIA 内部 DSP 上统计着信号输入量、获取接收量、活时等信息。可频繁调用函数读取 DSP 上的统计信息来监视时时获取速率。但是频繁调用该函数会对获取的 I/O 有一点影响。

由于每次拿到的不是完整数据，因此共享内存的在线监视也不容易实现，如若要实现，也不是没办法（从开始就decode记录每次数据的不完整事件的情况也可解决该问题，但是这样decode需要额外的时间）。

下面给出一些困难的解决思路：
牺牲 XIA 插件的灵活性，对一个插件设置成每个通道采集波形长度相同（这样就与 CAEN 一样了），因为每个通道的每个事件数据的长度相等，读取数据时候查询到当前的数据量之后，然后只读取事件长度整数倍的最大数据，这样每次拿到的都是完整的事件数据了，可参照 CAEN 的实现方式。

对采波形时候，可采用“伪”在线监视获取情况，即获取文件每隔一段时间保存一次，用上一轮的数据作为“在线”数据。

----

# 当前完成情况

当前完成情况：实验前期获取参数的调节（图形界面）、实验中数据采集（图形界面）、离线数据转换。

- 参数调节：运行程序先获取部分波形 -> 保存数据文件 -> 离线文件调节参数 -> 保存参数文件
- 数据获取：运行程序（读取调节好的参数） -> 正常获取数据
- 数据转换：将原始数据转ROOT文件

当前每个插件数据单独存在一个文件中，没有时时在线监视功能。Trigger Rate 监视通过不断 I/O 从插件 DSP 上获取。



以下为参数调节详细流程：

![程序界面](img/ReadWF1.png)

启动程序，界面如上图。按左端蓝色**Boot**按钮，等待初始化完成。可按蓝色**Read WF**按钮从插件中抓取时时波形。

![程序界面](img/ParGUI1.png)

上图为参数调节界面，涵盖了所有可调节参数。左上角菜单栏上**UV_Setup**可开启参数设置界面。

![程序界面](img/Start1.png)

上图为控制获取界面。先按**Complete**按钮设置文件路径等信息。然后即可按**LSRunStart**按钮开始获取数据。先采集部分数据。

![程序界面](img/TestPar1.png)

上图为离线数据调节参数界面。首先读取离线文件中的波形（图中黑线），然后调用插件中该路信号的参数画出 Trigger Filter（蓝线）、CFD（红线）、Energy Filter（绿线）、Baseline（黄线）曲线。可通过底端的参数调节窗口调节该路信号的参数直到符合实验要求。

![程序界面](img/SavePar1.png)

调节好以上参数后，按**UV_Setup**下的**Save2File**保存参数文件。然后修改**cfgPixie16.txt**文件中的倒数第二个参数为刚保存的文件。


# 正在进行

离线数据处理：

提供离线处理模块，模块实现读取之前保存的设置参数，ROOT文件可调用算法查看波形、能量、堆积等信息。

插件前面板的接口测试：

- 外部 Trigger 测试。
- 前面板监视信号的输出测试。

# 等待完成

- 由于老版本说明书（2009年版）中关于 符合/反符合 的设置说明已经不适用于当前版本 API 接口。我们与谭辉联系，他们当前正在更新说明书，等过几周新的说明书出来再加上 符合/反符合 设置。
- 当前图形界面基于ROOT5，改进以兼容ROOT6。
- 一些参数的设置要求、设置范围等还在请教谭辉，参数设置详细说明书将在之后给出。
- 离线参数调节界面添加快速查看能量分辨功能。

----

使用注意事项：

时间同步要求插件上跳针的接法第一个插件与其余插件不同。





<!-- Version1.md ends here -->
